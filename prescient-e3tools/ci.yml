.rules-e3tools-commit:
  rules:
  - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_EVENT_TYPE != "merge_train" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
    changes:
      - e3tools/**/*

e3tools lint:
  extends:
    - .rules-e3tools-commit
  stage: test
  needs: []
  image: python:3.9
  script:
    - shopt -s globstar
    - pip install pre-commit
    - pre-commit run --files e3tools/**/*
  tags:
    - cache
    - amd64

e3tools unit:
  extends:
    - .rules-e3tools-commit
  stage: test
  needs: []
  image: python:3.10
  script:
    - cd e3tools
    - pip install -r env/requirements.txt
    - pip install -e .[dev]
    - pytest tests
  tags:
    - cache
    - amd64

e3tools package:
  extends:
    - .package
  needs: []
  variables:
    PROJECT_DIRECTORY: e3tools
    GIT_STRATEGY: clone # clone entire repo instead of reusing workspace (see https://gitlab.com/gitlab-org/gitlab/-/issues/350100#note_899531082)
    GIT_DEPTH: 0 # need full history to construct version string
